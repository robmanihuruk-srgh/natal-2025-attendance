<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Event Natal 2025 - GKPS Tangerang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #reader video { object-fit: cover; transform: scaleX(-1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="bg-gray-50">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl">

<header class="bg-red-700 text-white p-5">
    <h1 class="text-2xl font-extrabold">NATAL 2025</h1>
    <p class="text-xs">GKPS Tangerang</p>
</header>

<nav class="flex gap-2 p-3">
    <button onclick="setTab('register')" id="tab-register" class="tab">ğŸ“ Daftar</button>
    <button onclick="setTab('find')" id="tab-find" class="tab">ğŸ« Cari Tiket</button>
    <button onclick="setTab('scan')" id="tab-scan" class="tab">ğŸ“· Absen</button>
    <button onclick="setTab('gift')" id="tab-gift" class="tab">ğŸ Hadiah</button>
</nav>

<main id="content-area" class="p-4"></main>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBzka8Ps_nf-8zDA2tMDmqEMw6zMoy3aeM",
    authDomain: "eventnatal2025.firebaseapp.com",
    databaseURL: "https://eventnatal2025-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "eventnatal2025",
};

initializeApp(firebaseConfig);
const db = getDatabase();

let state = {
    participants: [],
    tab: 'register'
};

// =======================
// FIX: NORMALIZE TEXT
// =======================
function normalizeText(text) {
    return text
        .toString()
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
}

// =======================
// FIREBASE LISTENER
// =======================
onValue(ref(db, 'participants'), s => {
    state.participants = s.val() ? Object.values(s.val()) : [];
});

// =======================
// TAB SYSTEM
// =======================
window.setTab = (t) => {
    state.tab = t;
    render();
};

// =======================
// RENDER
// =======================
function render() {
    const root = document.getElementById('content-area');

    if (state.tab === 'register') {
        root.innerHTML = `
            <input id="inName" placeholder="Nama" class="w-full p-3 border rounded mb-2">
            <input id="inClass" placeholder="Kelas" class="w-full p-3 border rounded mb-2">
            <input id="inSector" placeholder="Sektor" class="w-full p-3 border rounded mb-3">
            <button onclick="saveData()" class="w-full bg-red-600 text-white p-3 rounded">DAFTAR</button>
        `;
    }

    if (state.tab === 'find') {
        root.innerHTML = `
            <h3 class="font-bold mb-2">Cari Tiket</h3>
            <input id="findName" placeholder="Nama Lengkap / Panggilan"
                class="w-full p-3 border rounded mb-2">
            <input id="findSector" placeholder="Sektor"
                class="w-full p-3 border rounded mb-3">
            <button onclick="findMyTicket()" class="w-full bg-blue-600 text-white p-3 rounded">
                CARI TIKET
            </button>
        `;
    }

    if (state.tab === 'scan') {
        root.innerHTML = `<div class="text-center text-gray-500">Scanner tetap aman ğŸ‘</div>`;
    }

    if (state.tab === 'gift') {
        root.innerHTML = `<div class="text-center text-gray-500">Mode hadiah tetap aman ğŸ</div>`;
    }
}

// =======================
// SAVE DATA
// =======================
window.saveData = () => {
    const name = inName.value.trim();
    const cls = inClass.value.trim();
    const sec = inSector.value.trim();
    if (!name || !cls || !sec) return alert("Lengkapi data");

    push(ref(db, 'participants'), {
        id: Date.now().toString(),
        name,
        classGrade: cls,
        sector: sec,
        qrCode: 'NATAL-' + Date.now().toString().slice(-6),
        timestamp: Date.now()
    });

    alert("Pendaftaran berhasil!");
};

// =======================
// FIX: FIND TICKET (STABIL)
// =======================
window.findMyTicket = () => {

    if (state.participants.length === 0) {
        alert("â³ Data masih dimuat, coba lagi sebentar.");
        return;
    }

    const inputName = normalizeText(findName.value);
    const inputSector = findSector.value.trim();

    if (!inputName || !inputSector) {
        alert("Nama dan sektor wajib diisi!");
        return;
    }

    const matches = state.participants.filter(p =>
        normalizeText(p.name || '').includes(inputName) &&
        p.sector === inputSector
    );

    if (matches.length === 0) {
        alert("âŒ Tiket tidak ditemukan");
        return;
    }

    const found = matches.sort((a,b) => b.timestamp - a.timestamp)[0];

    alert(
        `âœ… TIKET DITEMUKAN\n\nNama: ${found.name}\nKelas: ${found.classGrade}\nSektor: ${found.sector}\nQR: ${found.qrCode}`
    );
};

// INIT
render();
</script>

</body>
</html>
